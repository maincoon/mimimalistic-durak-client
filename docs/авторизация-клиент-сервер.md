# Авторизация Клиент-Сервер

Параметры авторизации клиента состоят из двух частей:

* **Бандл + платформа клиента**
* **Параметры авторизации**

Бандл и платформа должны быть известны на клиенте (приложении) и в конфигурации UpDAU. По связке бандл + платформа UpDAU определяет **White Label (WL)**, с которым должен работать клиент. Параметры авторизации — это договоренность между приложением и WL.

Во внутренней реализации WL параметры авторизации состоят из двух частей: **схема (вид, тип) авторизации** и **данные авторизации** для указанной схемы.

Важно понимать, что платформа и бандл клиента никак не связаны с видом авторизации. Например, на iOS-устройстве можно использовать авторизацию по логину/паролю или по токену.

В результате успешной авторизации любого типа клиент получает данные профиля пользователя (в зависимости от WL список атрибутов и их трактовка могут различаться), а также токен UpDAU. Допустима авторизация по токену UpDAU независимо от того, какой тип авторизации был использован изначально.

Подробнее о формате сообщений см. в [Протокол Клиент-Сервер](протокол-клиент-сервер.md).

### Авторизация по токену UpDAU

```xml
<request cmd="auth" sign="auth">
    <token value="XXX"/>
</request>
```

## Схемы авторизации

Для внутренней реализации WL доступны следующие схемы:

### fb (FaceBook)

Необходимо указать:

* `type="fb"`
* `viewer_id` — идентификатор пользователя FB
* `access_token` — токен для проверки

```xml
<request cmd="auth" sign="auth">
    <credentials>
        <platform value="fb"/>
        <bundle value="3456789"/>
        <type value="fb"/>
        <api_id value="4885855"/>
        <viewer_id value="1234567"/>
        <access_token value="654321"/>
    </credentials>
</request>
```

### mm (Мой Мир)

Необходимо указать:

* `type="mm"`
* `api_id` — идентификатор приложения
* `vid` — идентификатор пользователя ММ
* `session_key` — ключ сессии пользователя
* `sig` — подпись параметров

```xml
<request cmd="auth" sign="auth">
    <credentials>
        <platform value="mm"/>
        <bundle value="3456789"/>
        <type value="mm"/>
        <api_id value="464119"/>
        <vid value="1324730981306483817"/>
        <session_key value="28ec5ee94bb0fdd90e0a86b19317d860"/>
    </credentials>
</request>
```

### ok (Одноклассники)

Осуществляется двумя способами.

**Вариант 1:** С подписью параметров.

* `type="ok"`
* `viewer_id` — идентификатор пользователя
* `session_key` — ключ сессии
* `auth_sig` — подпись параметров: `md5(viewer_id + session_key + application_secret_key)`

```xml
<request cmd="auth" sign="auth">
    <credentials>
        <platform value="ok"/>
        <bundle value="3456789"/>
        <type value="ok"/>
        <api_id value="464119"/>
        <viewer_id value="1324730981306483817"/>
        <auth_sig value="3eded1975995a5102fb3724816758fcf"/>
        <session_key value="28ec5ee94bb0fdd90e0a86b19317d860"/>
    </credentials>
</request>
```

**Вариант 2:** С OAuth-токеном.

* `type="ok"`
* `viewer_id` — идентификатор пользователя
* `access_token` — токен OAuth
* `api_id` — идентификатор приложения

```xml
<request cmd="auth" sign="auth">
    <credentials>
        <platform value="ok"/>
        <bundle value="3456789"/>
        <type value="ok"/>
        <api_id value="464119"/>
        <viewer_id value="1324730981306483817"/>
        <access_token value="3eded1975995a5102fb3724816758fcf"/>
    </credentials>
</request>
```

### vk (ВКонтакте)

Необходимо указать:

* `type="vk"`
* `api_id` — ИД приложения ВК
* `viewer_id` — ИД пользователя ВК
* `auth_key` — ключ для проверки (в соответствии с [VK Dev](https://vk.com/dev/apps_init))
* Либо `access_token` в случае OAuth-авторизации (если присланы оба — приоритет у `auth_key`).

```xml
<request cmd="auth" sign="auth">
    <credentials>
        <platform value="vk"/>
        <bundle value="4885855"/>
        <type value="vk">
        <api_id value="4885855"/>
        <viewer_id value="21428230"/>
        <!-- Одно из полей: -->
        <auth_key value="3eded1975995a5102fb3724816758fcf"/>
        <access_token value="112233444885855"/>
    </credentials>
</request>
```

### lp (Login/Password)

Необходимо указать:

* `type="lp"`
* `login`
* `password`

```xml
<request cmd="auth" sign="auth">
    <credentials>
        <platform value="vk"/>
        <bundle value="4885855"/>
        <type value="lp"/>
        <login value="d1"/>
        <password value="d1"/>
    </credentials>
</request>
```

### device (Device ID)

Авторизация по идентификатору устройства.

* `type="device"`
* `device_type` — тип устройства (ios, android и т.д.)
* `device_id` — уникальный идентификатор устройства

```xml
<request cmd="auth" sign="auth">
    <credentials>
        <platform value="ios"/>
        <bundle value="skillgames.globo.com"/>
        <type value="device"/>
        <device_type value="ios"/>
        <device_id value="11223344"/>
    </credentials>
</request>
```

### token (Token)

Прямая авторизация по токену сессии.

* `type="token"`
* `token`

```xml
<request cmd="auth" sign="auth">
    <credentials>
        <platform value="sa"/>
        <bundle value="dev-client-test"/>
        <type value="token"/>
        <token value="aabbcc11223344"/>
    </credentials>
</request>
```

### demo (Demo)

Доступна только на Demo WL (необходимо уточнять конфигурацию).

* `type="demo"`
* `cookie` — идентификатор пользователя для демо-доступа
* `wallet` — (опционально) начальный баланс

```xml
<request cmd="auth" sign="auth">
    <credentials>
        <type value="demo"/>
        <platform value="sa"/>
        <bundle value="demo"/>
        <cookie value="1"/>
        <wallet value="1000"/>
    </credentials>
</request>
```

### transfer (Перенос аккаунта)

Перенос данных пользователя из схемы `device` в другую схему авторизации (например, при привязке аккаунта к соцсети).

**Принцип работы:**

1. Указывается `device_type` и `device_id`.
2. Указывается целевой тип авторизации (`target`) и соответствующие ему поля.
3. Если целевая авторизация создает нового пользователя, данные, привязанные к устройству, переносятся и удаляются с устройства.
4. Если целевая авторизация уже содержит пользователя, данные устройства сохраняются отдельно, позволяя клиенту вернуться к ним.

```xml
<request cmd="auth" sign="auth">
    <credentials>
        <platform value="sa"/>
        <bundle value="dev-client-test"/>
        <type value="transfer"/>
        <device_type value="ios"/>
        <device_id value="11223344"/>
        <target value="vk"/>
        <!-- Поля целевой авторизации (пример для VK) -->
        <api_id value="4885855"/>
        <viewer_id value="21428230"/>
        <auth_key value="3eded1975995a5102fb3724816758fcf"/>
    </credentials>
</request>
```
  